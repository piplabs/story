syntax = "proto3";
package story.dkg.v1.tee;

import "gogoproto/gogo.proto";
import "story/dkg/v1/types/types.proto";

option go_package = "github.com/piplabs/story/client/dkg";

service TEE {
  rpc GenerateAndSealKey(GenerateAndSealKeyRequest) returns (GenerateAndSealKeyResponse);
  rpc VerifyRawQuote(VerifyRawQuoteRequest) returns (VerifyRawQuoteResponse);
  rpc SetupDKGNetwork(SetupDKGNetworkRequest) returns (SetupDKGNetworkResponse);
  rpc GenerateDeals(GenerateDealsRequest) returns (GenerateDealsResponse);
  rpc ProcessDeals(ProcessDealRequest) returns (ProcessDealResponse);
  rpc ProcessResponses(ProcessResponsesRequest) returns (ProcessResponsesResponse);
  rpc FinalizeDKG(FinalizeDKGRequest) returns (FinalizeDKGResponse);
}

// GenerateAndSealKeyRequest is sent to TEE client to generate and seal a key
message GenerateAndSealKeyRequest {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  string address = 3 [
    (gogoproto.moretags) = "yaml:\"address\""
  ];
}

// GenerateAndSealKeyResponse is returned from TEE client after key generation
message GenerateAndSealKeyResponse {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  bytes dkg_pub_key = 3 [
    (gogoproto.moretags) = "yaml:\"dkg_pub_key\""
  ];

  bytes comm_pub_key = 4 [
    (gogoproto.moretags) = "yaml:\"comm_pub_key\""
  ];

  bytes raw_quote = 5 [
    (gogoproto.moretags) = "yaml:\"raw_quote\""
  ];
}

// VerifyRawQuoteRequest is sent to TEE client to verify a raw quote
message VerifyRawQuoteRequest {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  string address = 3 [
    (gogoproto.moretags) = "yaml:\"address\""
  ];

  bytes dkg_pub_key = 4 [
    (gogoproto.moretags) = "yaml:\"dkg_pub_key\""
  ];

  bytes comm_pub_key = 5 [
    (gogoproto.moretags) = "yaml:\"comm_pub_key\""
  ];

  bytes raw_quote = 6 [
    (gogoproto.moretags) = "yaml:\"raw_quote\""
  ];
}

message VerifyRawQuoteResponse {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  string address = 2 [
    (gogoproto.moretags) = "yaml:\"address\""
  ];

  uint32 round = 3 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  bool valid = 4 [
    (gogoproto.moretags) = "yaml:\"valid\""
  ];
}

// SetupDKGNetworkRequest is sent to TEE client to setup DKG network
message SetupDKGNetworkRequest {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  uint32 total = 3 [
    (gogoproto.moretags) = "yaml:\"total\""
  ];

  uint32 threshold = 4 [
    (gogoproto.moretags) = "yaml:\"threshold\""
  ];

  repeated types.DKGRegistration registrations = 5 [
    (gogoproto.nullable) = false,
    (gogoproto.moretags) = "yaml:\"registrations\""
  ];
}

// SetupDKGNetworkResponse is returned from TEE client after DKG network setup
message SetupDKGNetworkResponse {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  uint32 total = 3 [
    (gogoproto.moretags) = "yaml:\"total\""
  ];

  uint32 threshold = 4 [
    (gogoproto.moretags) = "yaml:\"threshold\""
  ];

  bytes signature = 5 [
    (gogoproto.moretags) = "yaml:\"signature\""
  ];
}

// GenerateDealsRequest is sent to TEE client to generate deals
message GenerateDealsRequest {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];
}

// GenerateDealsResponse is returned from TEE client with generated deals
message GenerateDealsResponse {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  repeated types.Deal deals = 3 [
    (gogoproto.nullable) = false,
    (gogoproto.moretags) = "yaml:\"deals\""
  ];
}

// ProcessDealRequest is sent to TEE client to process deals
message ProcessDealRequest {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  repeated types.Deal deals = 3 [
    (gogoproto.nullable) = false,
    (gogoproto.moretags) = "yaml:\"deals\""
  ];
}

// ProcessDealResponse is returned from TEE client after processing deals
message ProcessDealResponse {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  repeated types.Response responses = 3 [
    (gogoproto.nullable) = false,
    (gogoproto.moretags) = "yaml:\"responses\""
  ];
}

message ProcessResponsesRequest {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  repeated types.Response responses = 3 [
    (gogoproto.moretags) = "yaml:\"responses\""
  ];
}

message ProcessResponsesResponse {
  repeated Justification justifications = 1 [
    (gogoproto.moretags) = "yaml:\"justifications\""
  ];
}

// FinalizeDKGRequest is sent to TEE client to finalize DKG
message FinalizeDKGRequest {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];
}

// FinalizeDKGResponse is returned from TEE client after DKG finalization
message FinalizeDKGResponse {
  bytes mrenclave = 1 [
    (gogoproto.moretags) = "yaml:\"mrenclave\""
  ];

  uint32 round = 2 [
    (gogoproto.moretags) = "yaml:\"round\""
  ];

  bytes global_pub_key = 3 [
    (gogoproto.moretags) = "yaml:\"global_pub_key\""
  ];

  bytes signature = 4 [
    (gogoproto.moretags) = "yaml:\"signature\""
  ];
}

message Justification {
  uint32 index = 1 [
    (gogoproto.moretags) = "yaml:\"index\""
  ];

  VSSJustification vss_justification = 2 [
    (gogoproto.moretags) = "yaml:\"vss_justification\""
  ];
}

message VSSJustification {
  bytes session_id = 1 [
    (gogoproto.moretags) = "yaml:\"session_id\""
  ];

  uint32 index = 2 [
    (gogoproto.moretags) = "yaml:\"index\""
  ];

  PlainDeal plain_deal = 3 [
    (gogoproto.moretags) = "yaml:\"plain_deal\""
  ];

  bytes signature = 4 [
    (gogoproto.moretags) = "yaml:\"signature\""
  ];
}

message PlainDeal {
  bytes session_id = 1 [
    (gogoproto.moretags) = "yaml:\"session_id\""
  ];

  SecShare sec_share = 2 [
    (gogoproto.moretags) = "yaml:\"sec_share\""
  ];

  uint32 threshold = 3 [
    (gogoproto.moretags) = "yaml:\"threshold\""
  ];

  repeated Point commitments = 4 [
    (gogoproto.moretags) = "yaml:\"commitments\""
  ];
}

message SecShare {
  uint32 I = 1 [
    (gogoproto.moretags) = "yaml:\"i\""
  ];

  Scalar V = 2 [
    (gogoproto.moretags) = "yaml:\"v\""
  ];
}

message Scalar {
  bytes data = 1 [
    (gogoproto.moretags) = "yaml:\"data\""
  ];
}

message Point {
  bytes data = 1 [
    (gogoproto.moretags) = "yaml:\"data\""
  ];
}